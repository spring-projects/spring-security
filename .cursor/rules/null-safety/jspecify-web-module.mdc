---
description: JSpecify null safety implementation patterns and best practices for the Spring Security @web module
alwaysApply: false
---

# JSpecify Null Safety Implementation - @web Module

## Overview

The Spring Security **@web module** has adopted **JSpecify** for null safety annotations following the same patterns established in the @core module. The web module includes **55+ packages** marked with `@NullMarked` and contains **737+ usages** of `@Nullable` annotations across 257 files, providing compile-time null safety guarantees for web-related security components.

## Build Configuration

### Gradle Plugin Setup

**Plugin Declaration**: `web/spring-security-web.gradle`

```gradle
plugins {
    id 'io.spring.convention.spring-module'
    id 'security-nullability'
    id 'javadoc-warnings-error'
    id 'test-compile-target-jdk25'
}
```

The web module uses the **same `security-nullability` plugin** as the core module, ensuring consistent null safety enforcement across the codebase.

### Checkstyle Enforcement

The web module inherits the same Checkstyle configuration from `etc/checkstyle/checkstyle.xml` that enforces:
- **Only JSpecify annotations** are allowed (`org.jspecify.annotations.*`)
- Rejects all other nullability frameworks (JSR-305, JetBrains, etc.)

## Implementation Patterns

### 1. Package-Level `@NullMarked`

**Default Non-Null Context**: All web packages use `@NullMarked` to establish a non-null default.

**Example**: `web/src/main/java/org/springframework/security/web/package-info.java`

```java
@NullMarked
package org.springframework.security.web;

import org.jspecify.annotations.NullMarked;
```

**Key Packages** (55+ total):
- `org.springframework.security.web` - Root package
- `org.springframework.security.web.authentication` - Authentication filters
- `org.springframework.security.web.authentication.logout` - Logout handlers
- `org.springframework.security.web.authentication.rememberme` - Remember-me services
- `org.springframework.security.web.csrf` - CSRF protection
- `org.springframework.security.web.savedrequest` - Saved request handling
- `org.springframework.security.web.server.*` - Reactive WebFlux support
- `org.springframework.security.web.method.annotation` - Method argument resolvers
- `org.springframework.security.web.servletapi` - Servlet API integration
- And many more subpackages...

### 2. Servlet Filter Method Return Types

**Pattern**: Filter methods that can return null use `@Nullable` on return types.

**Example**: `web/src/main/java/org/springframework/security/web/authentication/AbstractAuthenticationProcessingFilter.java`

```java
/**
 * @return the authenticated user token, or null if authentication is incomplete.
 */
public @Nullable Authentication attemptAuthentication(HttpServletRequest request, 
        HttpServletResponse response)
        throws AuthenticationException, IOException, ServletException {
    Authentication authentication = this.authenticationConverter.convert(request);
    if (authentication == null) {
        return null;
    }
    Authentication result = this.authenticationManager.authenticate(authentication);
    if (result == null) {
        throw new ServletException("AuthenticationManager should not return null Authentication object.");
    }
    return result;
}
```

### 3. Interface Method Contracts

**Pattern**: Interface methods declare nullability contracts that implementations must follow.

**Example**: `web/src/main/java/org/springframework/security/web/authentication/AuthenticationConverter.java`

```java
public interface AuthenticationConverter {
    @Nullable Authentication convert(HttpServletRequest request);
}
```

**Example**: `web/src/main/java/org/springframework/security/web/savedrequest/RequestCache.java`

```java
public interface RequestCache {
    @Nullable SavedRequest getRequest(HttpServletRequest request, HttpServletResponse response);
    
    @Nullable HttpServletRequest getMatchingRequest(HttpServletRequest request, 
            HttpServletResponse response);
}
```

**Example**: `web/src/main/java/org/springframework/security/web/csrf/CsrfTokenRepository.java`

```java
public interface CsrfTokenRepository {
    void saveToken(@Nullable CsrfToken token, HttpServletRequest request, 
            HttpServletResponse response);
    
    @Nullable CsrfToken loadToken(HttpServletRequest request);
}
```

### 4. Pre-Authentication Filter Patterns

**Pattern**: Pre-authentication filters that extract credentials from headers/requests use `@Nullable` extensively.

**Example**: `web/src/main/java/org/springframework/security/web/authentication/preauth/RequestHeaderAuthenticationFilter.java`

```java
public class RequestHeaderAuthenticationFilter extends AbstractPreAuthenticatedProcessingFilter {

    private String principalRequestHeader = "SM_USER";
    private @Nullable String credentialsRequestHeader;
    
    @Override
    protected @Nullable Object getPreAuthenticatedPrincipal(HttpServletRequest request) {
        String principal = request.getHeader(this.principalRequestHeader);
        if (principal == null && this.exceptionIfHeaderMissing) {
            throw new PreAuthenticatedCredentialsNotFoundException(
                    this.principalRequestHeader + " header not found in request.");
        }
        return principal;
    }
    
    @Override
    protected @Nullable Object getPreAuthenticatedCredentials(HttpServletRequest request) {
        if (this.credentialsRequestHeader != null) {
            return request.getHeader(this.credentialsRequestHeader);
        }
        return "N/A";
    }
}
```

### 5. Saved Request Handling

**Pattern**: Complex DTOs with multiple nullable fields representing HTTP request state.

**Example**: `web/src/main/java/org/springframework/security/web/savedrequest/DefaultSavedRequest.java`

```java
public class DefaultSavedRequest implements SavedRequest {
    
    private final @Nullable String contextPath;
    private final String method;
    private final @Nullable String pathInfo;
    private final @Nullable String queryString;
    private final String requestURI;
    private final @Nullable String requestURL;
    private final String scheme;
    private final String serverName;
    private final @Nullable String servletPath;
    private final int serverPort;
    private final @Nullable String matchingRequestParameterName;
    
    public DefaultSavedRequest(HttpServletRequest request, 
            @Nullable String matchingRequestParameterName) {
        // ... initialization
        this.contextPath = request.getContextPath();
        this.servletPath = request.getServletPath();
        this.matchingRequestParameterName = matchingRequestParameterName;
    }
}
```

### 6. Builder Pattern with Nullable Fields

**Pattern**: Builders for complex objects use `@Nullable` for optional configuration.

**Example**: `web/src/main/java/org/springframework/security/web/savedrequest/DefaultSavedRequest.Builder`

```java
public static class Builder {
    
    private @Nullable List<SavedCookie> cookies = null;
    private @Nullable List<Locale> locales = null;
    private @Nullable String contextPath;
    private @Nullable String method;
    private @Nullable String pathInfo;
    private @Nullable String queryString;
    private @Nullable String requestURI;
    private @Nullable String requestURL;
    private @Nullable String scheme;
    private @Nullable String serverName;
    private @Nullable String servletPath;
    
    public Builder setQueryString(@Nullable String queryString) {
        this.queryString = queryString;
        return this;
    }
    
    public DefaultSavedRequest build() {
        return new DefaultSavedRequest(this);
    }
}
```

### 7. Array Type Annotations in Utility Methods

**Pattern**: JSpecify type-use annotations on array return types for parsing utilities.

**Example**: `web/src/main/java/org/springframework/security/web/authentication/www/DigestAuthUtils.java`

```java
final class DigestAuthUtils {

    // Returns a nullable array of nullable strings
    static String @Nullable [] splitIgnoringQuotes(String str, char separatorChar) {
        if (str == null) {
            return null;
        }
        // ... parsing logic
        return list.toArray(new String[0]);
    }
    
    // Returns a nullable array of non-null strings
    static String @Nullable [] split(String toSplit, String delimiter) {
        int offset = toSplit.indexOf(delimiter);
        if (offset < 0) {
            return null;
        }
        return new String[] { beforeDelimiter, afterDelimiter };
    }
    
    // Returns a nullable map with parameters
    static @Nullable Map<String, String> splitEachArrayElementAndCreateMap(
            String @Nullable [] array, String delimiter, String removeCharacters) {
        if ((array == null) || (array.length == 0)) {
            return null;
        }
        Map<String, String> map = new HashMap<>();
        // ... processing
        return map;
    }
}
```

### 8. Method Argument Resolvers

**Pattern**: Spring MVC/WebFlux argument resolvers that may return null.

**Example**: `web/src/main/java/org/springframework/security/web/method/annotation/AuthenticationPrincipalArgumentResolver.java`

```java
public final class AuthenticationPrincipalArgumentResolver 
        implements HandlerMethodArgumentResolver {

    private @Nullable BeanResolver beanResolver;
    
    @Override
    public @Nullable Object resolveArgument(MethodParameter parameter, 
            @Nullable ModelAndViewContainer mavContainer,
            NativeWebRequest webRequest, 
            @Nullable WebDataBinderFactory binderFactory) {
        Authentication authentication = this.securityContextHolderStrategy
                .getContext().getAuthentication();
        if (authentication == null) {
            return null;
        }
        Object principal = authentication.getPrincipal();
        // ... resolution logic
        return principal;
    }
}
```

### 9. Servlet API Integration with Nullable Fields

**Pattern**: Factory classes that integrate with Servlet 3 APIs use nullable for optional components.

**Example**: `web/src/main/java/org/springframework/security/web/servletapi/HttpServlet3RequestFactory.java`

```java
final class HttpServlet3RequestFactory implements HttpServletRequestFactory {

    private @Nullable AuthenticationEntryPoint authenticationEntryPoint;
    private @Nullable AuthenticationManager authenticationManager;
    private @Nullable List<LogoutHandler> logoutHandlers;
    
    void setAuthenticationEntryPoint(
            @Nullable AuthenticationEntryPoint authenticationEntryPoint) {
        this.authenticationEntryPoint = authenticationEntryPoint;
    }
    
    void setAuthenticationManager(@Nullable AuthenticationManager authenticationManager) {
        this.authenticationManager = authenticationManager;
    }
    
    void setLogoutHandlers(@Nullable List<LogoutHandler> logoutHandlers) {
        this.logoutHandlers = logoutHandlers;
    }
}
```

### 10. Reactive (WebFlux) Patterns

**Pattern**: Reactive interfaces use `Mono` to represent absence instead of `@Nullable` for reactive streams, but still use `@Nullable` for synchronous operations.

**Example**: `web/src/main/java/org/springframework/security/web/server/authentication/ServerAuthenticationConverter.java`

```java
@FunctionalInterface
public interface ServerAuthenticationConverter {
    // Returns Mono instead of @Nullable for reactive absence
    Mono<Authentication> convert(ServerWebExchange exchange);
}
```

**Example**: `web/src/main/java/org/springframework/security/web/server/savedrequest/ServerRequestCache.java`

```java
public interface ServerRequestCache {
    Mono<Void> saveRequest(ServerWebExchange exchange);
    Mono<URI> getRedirectUri(ServerWebExchange exchange);
    Mono<ServerHttpRequest> removeMatchingRequest(ServerWebExchange exchange);
}
```

**Key Insight**: Reactive types (`Mono`/`Flux`) handle absence through their type system, so `@Nullable` is **not needed** for return values. However, nullable parameters in reactive code still use `@Nullable`.

### 11. @Contract Annotations for Complex Logic

**Pattern**: Use Spring's `@Contract` annotation alongside `@Nullable` for specifying behavior with null inputs.

**Example**: `web/src/main/java/org/springframework/security/web/authentication/AbstractAuthenticationProcessingFilter.java`

```java
@Contract("null, _ -> false")
private boolean shouldPerformMfa(@Nullable Authentication current, 
        Authentication authenticationResult) {
    if (!this.mfaEnabled) {
        return false;
    }
    if (current == null || !current.isAuthenticated()) {
        return false;
    }
    return current.getName().equals(authenticationResult.getName());
}
```

**Example**: `web/src/main/java/org/springframework/security/web/authentication/www/BasicAuthenticationFilter.java`

```java
@Contract("null, _ -> false")
private boolean authenticationIsRequired(@Nullable Authentication existingAuth, 
        UsernamePasswordAuthenticationToken newAuth) {
    if (existingAuth == null || !existingAuth.isAuthenticated()) {
        return true;
    }
    return !existingAuth.getName().equals(newAuth.getName());
}
```

### 12. Cookie and Header Configuration

**Pattern**: Cookie/header configuration classes with nullable optional settings.

**Example**: `web/src/main/java/org/springframework/security/web/csrf/CookieCsrfTokenRepository.java`

```java
public final class CookieCsrfTokenRepository implements CsrfTokenRepository {

    private @Nullable String cookiePath;
    private @Nullable String cookieDomain;
    private @Nullable Boolean secure;
    
    @Override
    public void saveToken(@Nullable CsrfToken token, HttpServletRequest request, 
            HttpServletResponse response) {
        String tokenValue = (token != null) ? token.getToken() : "";
        
        ResponseCookie.ResponseCookieBuilder cookieBuilder = 
            ResponseCookie.from(this.cookieName, tokenValue)
                .secure((this.secure != null) ? this.secure : request.isSecure())
                .path(StringUtils.hasLength(this.cookiePath) 
                    ? this.cookiePath 
                    : this.getRequestContext(request))
                .domain(this.cookieDomain);
    }
}
```

### 13. Login Page Generation

**Pattern**: UI filters with nullable configuration for optional URLs and settings.

**Example**: `web/src/main/java/org/springframework/security/web/authentication/ui/DefaultLoginPageGeneratingFilter.java`

```java
public class DefaultLoginPageGeneratingFilter extends GenericFilterBean {

    private @Nullable String loginPageUrl;
    private @Nullable String logoutSuccessUrl;
    private @Nullable String failureUrl;
    private @Nullable String authenticationUrl;
    
    // Configuration setters accept nullable values
    public void setLoginPageUrl(@Nullable String loginPageUrl) {
        this.loginPageUrl = loginPageUrl;
    }
}
```

### 14. Static Method Fields for Reflection

**Pattern**: Static nullable fields used in reflection-based utilities.

**Example**: `web/src/main/java/org/springframework/security/web/authentication/preauth/websphere/DefaultWASUsernameAndGroupsExtractor.java`

```java
final class DefaultWASUsernameAndGroupsExtractor 
        implements WASUsernameAndGroupsExtractor {

    private static @Nullable Method getRunAsSubject = null;
    private static @Nullable Method getGroupsForUser = null;
    private static @Nullable Method getSecurityName = null;
    private static @Nullable Method narrow = null;
    private static @Nullable Class<?> wsCredentialClass = null;
    
    private static @Nullable String getSecurityName(final Subject subject) {
        String userSecurityName = null;
        if (subject != null) {
            Object credential = subject.getPublicCredentials(getWSCredentialClass())
                    .iterator().next();
            if (credential != null) {
                userSecurityName = (String) invokeMethod(getSecurityNameMethod(), credential);
            }
        }
        return userSecurityName;
    }
}
```

### 15. @SuppressWarnings for NullAway Limitations

**Pattern**: Strategic use of `@SuppressWarnings("NullAway")` for known tool limitations.

**Common Cases**:

1. **Initialization patterns** - Fields initialized in `afterPropertiesSet()`:

```java
public abstract class AbstractPreAuthenticatedProcessingFilter 
        extends GenericFilterBean {

    @SuppressWarnings("NullAway.Init")
    private AuthenticationManager authenticationManager;
    
    @Override
    public void afterPropertiesSet() {
        Assert.notNull(this.authenticationManager, 
                "An AuthenticationManager must be set");
    }
}
```

2. **Constructor dataflow analysis limitations**:

```java
@SuppressWarnings("NullAway") // Dataflow analysis limitation
public LogoutFilter(LogoutSuccessHandler logoutSuccessHandler, 
        LogoutHandler... handlers) {
    this.handler = new CompositeLogoutHandler(handlers);
    Assert.notNull(logoutSuccessHandler, "logoutSuccessHandler cannot be null");
    this.logoutSuccessHandler = logoutSuccessHandler;
    setFilterProcessesUrl("/logout");
}
```

3. **Reactive operator limitations**:

```java
@Override
@SuppressWarnings("NullAway") // https://github.com/uber/NullAway/issues/1290
public Mono<Object> resolveArgument(MethodParameter parameter, 
        BindingContext bindingContext, ServerWebExchange exchange) {
    return ReactiveSecurityContextHolder.getContext()
        .mapNotNull(SecurityContext::getAuthentication)
        .flatMap((authentication) -> {
            // NullAway doesn't understand mapNotNull guarantees
            return resolvePrincipal(parameter, authentication.getPrincipal());
        });
}
```

### 16. Delegating Entry Points

**Pattern**: Delegation classes that select from multiple nullable or non-nullable options.

**Example**: `web/src/main/java/org/springframework/security/web/authentication/DelegatingAuthenticationEntryPoint.java`

```java
public class DelegatingAuthenticationEntryPoint 
        implements AuthenticationEntryPoint, InitializingBean {

    private final List<RequestMatcherEntry<AuthenticationEntryPoint>> entryPoints;
    
    @SuppressWarnings("NullAway.Init")
    private AuthenticationEntryPoint defaultEntryPoint;
    
    @Override
    public void afterPropertiesSet() {
        Assert.notNull(this.defaultEntryPoint, 
                "defaultEntryPoint must be specified");
    }
}
```

## Web Module-Specific Patterns

### 1. HttpServletRequest Integration

The web module extensively uses `@Nullable` for methods that extract data from HTTP requests:

- **Header extraction** - may return null if header not present
- **Parameter extraction** - may return null if parameter not present
- **Cookie extraction** - may return null if cookie not present
- **Session attributes** - may return null if not set

### 2. Filter Chain Processing

Filters that can short-circuit authentication:

- Return `@Nullable Authentication` if authentication is incomplete
- Use `@Contract("null, _ -> false")` for MFA and authentication checks

### 3. SavedRequest Patterns

Saved requests preserve HTTP request state with many optional components:

- Context path, servlet path, path info all nullable
- Query string nullable
- Matching request parameter name nullable

### 4. Reactive vs Servlet Duality

The web module supports both:

- **Servlet API** (`org.springframework.security.web.*`) - uses `@Nullable` extensively
- **Reactive WebFlux** (`org.springframework.security.web.server.*`) - uses `Mono` for absence

## Best Practices Summary

### ✅ DO

1. **Apply `@NullMarked` at package level** - All 55+ web packages follow this
2. **Use `@Nullable` for optional HTTP components** - Headers, parameters, cookies
3. **Use `@Nullable` for converter interfaces** - `AuthenticationConverter`, etc.
4. **Use `Mono` for reactive absence** - Don't use `@Nullable` with reactive return types
5. **Use `@Contract` for null-checking methods** - Especially in filter logic
6. **Suppress NullAway strategically** - Document the reason with issue links
7. **Keep nullable fields private** - Expose through getter methods
8. **Use builders for complex DTOs** - `DefaultSavedRequest.Builder`

### ❌ DON'T

1. **Don't use `@Nullable` with reactive return types** - Use `Mono.empty()` instead
2. **Don't forget constructor parameters** - They need `@Nullable` too
3. **Don't mix nullable with Optional** - Pick one pattern and stick to it
4. **Don't suppress NullAway without explanation** - Include issue links

## Coverage Statistics

**In the @web module**:
- **55+ packages** are `@NullMarked`
- **737+ usages** of `@Nullable` annotations across 257 files
- **15 strategic suppressions** of NullAway for tool limitations
- **100% consistency** with JSpecify (enforced by Checkstyle)

## Comparison with @core Module

| Aspect | @core Module | @web Module |
|--------|-------------|-------------|
| Packages | 40+ | 55+ |
| @Nullable Usages | 600+ | 737+ |
| Build Plugin | `security-nullability` | `security-nullability` |
| Checkstyle | JSpecify only | JSpecify only |
| Reactive Support | Limited (Mono/Flux in some areas) | Extensive (full WebFlux support) |
| Array Annotations | Yes | Yes (especially in parsing utilities) |
| Builder Pattern | Yes | Yes (especially SavedRequest) |
| @Contract Usage | Yes | Yes (filter logic) |

## Key Files Reference

### Configuration
- **Build Config**: `web/spring-security-web.gradle`
- **Root Package**: `web/src/main/java/org/springframework/security/web/package-info.java`

### Core Interfaces
- **AuthenticationConverter**: `web/src/main/java/org/springframework/security/web/authentication/AuthenticationConverter.java`
- **RequestCache**: `web/src/main/java/org/springframework/security/web/savedrequest/RequestCache.java`
- **CsrfTokenRepository**: `web/src/main/java/org/springframework/security/web/csrf/CsrfTokenRepository.java`

### Filter Examples
- **AbstractAuthenticationProcessingFilter**: `web/src/main/java/org/springframework/security/web/authentication/AbstractAuthenticationProcessingFilter.java`
- **AbstractPreAuthenticatedProcessingFilter**: `web/src/main/java/org/springframework/security/web/authentication/preauth/AbstractPreAuthenticatedProcessingFilter.java`
- **RequestHeaderAuthenticationFilter**: `web/src/main/java/org/springframework/security/web/authentication/preauth/RequestHeaderAuthenticationFilter.java`

### Complex Patterns
- **DefaultSavedRequest**: `web/src/main/java/org/springframework/security/web/savedrequest/DefaultSavedRequest.java`
- **DigestAuthUtils**: `web/src/main/java/org/springframework/security/web/authentication/www/DigestAuthUtils.java`
- **CookieCsrfTokenRepository**: `web/src/main/java/org/springframework/security/web/csrf/CookieCsrfTokenRepository.java`

### Reactive Examples
- **ServerAuthenticationConverter**: `web/src/main/java/org/springframework/security/web/server/authentication/ServerAuthenticationConverter.java`
- **ServerRequestCache**: `web/src/main/java/org/springframework/security/web/server/savedrequest/ServerRequestCache.java`

## Conclusion

The Spring Security @web module demonstrates **production-grade null safety** using JSpecify annotations with:

- **Comprehensive coverage** across all web-related security components
- **Consistent patterns** matching the @core module approach
- **Web-specific adaptations** for servlet and reactive environments
- **Strategic handling** of optional HTTP components (headers, cookies, parameters)
- **Proper distinction** between servlet (`@Nullable`) and reactive (`Mono.empty()`) patterns
- **Build-time enforcement** through Checkstyle and the nullability plugin

The implementation serves as a reference for applying null safety to web frameworks that must handle numerous optional HTTP components while maintaining both blocking servlet and reactive WebFlux APIs.
